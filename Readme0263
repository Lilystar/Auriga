----------------------------------------
//0288 [2007/08/24] by Rayce

・skill_check_condition2_pc() を少しだけ整理（skill.c）
・処理効率を上げるために clif_takeitem() をマクロから関数に変更
　（clif.*, mob.c, pc.c, pet.c, skill.c）

・conf/script_auriga.confに error_marker_start, error_marker_end を追加（script.c）
	スクリプトの解析エラーが発生したとき、エラー箇所を特定しやすくするために好きな文字列を
	指定することができます（15文字まで）。
	script.c内部でのデフォルトは空文字になっているので、該当項目をコメントアウトすれば
	文字を表示しない設定にすることもできます。

・以下のスキルについて、skill_require_db.txtのstateの項目にfalconを設定しなかったときでもスキルが
　発動できるように拡張（skill.c）
	ブリッツビート
	ディテクティング
	スプリングトラップ
	ファルコンアサルト
・skill_require_db.txtのstateの項目に新しく以下の2つを追加（skill.*）
	cartboost: カートブースト状態
	nen: 念状態

・db/skill_require_db.txtを上記変更に従って修正
・doc/script_ref.txtにpet命令が記載されてなかったので修正

----------------------------------------
//0287 [2007/08/24] by Rayce

・TXT: 0140以降、サーバ起動中にアカウントやキャラを削除すると、他の特定のアカウントやキャラがログイン
       不可能になる致命的なバグを修正（login.c, char.c）
		reported by Cocoaさん、thanks a lot!!

	アカウントやキャラを削除するときにIDも0に初期化してしまうため、バイナリサーチが正常に機能
	しなくなるのがが原因でした。
	IDは維持したままの状態にして、他のメンバで削除されているかどうかを判定するようにします。
	loginの場合はmmo_account構造体のuseridが空文字ならauth_datから削除済み、
	charの場合はmmo_charstatus構造体のaccount_idが0ならchar_datから削除済み、とみなします。

・SQL: loginサーバで使うアカウントデータのキャッシュが有効利用されてなかったので修正（login.c）
・SQL: loginサーバ起動中にアカウントを削除するとそのアカウントがキャッシュから削除されずに
       残り続けるバグを修正（login.c）

・MAX_SERVERSを MAX_CHAR_SERVERS に改名（login.*）
　MAX_CHAR_SERVERS を 30 → 8 に縮小しておく
・MAX_MAP_SERVERS を 30 → 8 に縮小しておく（char.*）

　　※charサーバおよびmapサーバを8個よりもさらに設置したい場合はこれらの値を増やしてください

----------------------------------------
//0286 [2007/08/23] by Rayce

・AthenaProject2317より、エスマのLv10以外の倍率を修正（battle.c）
・Athena1468で抜け落ちたディバインプロテクションの効果を再実装（battle.c）
	from AthenaProject BTS, thanks
・聖体降福が対人エリアだと自身とPTメンバーにしか掛からなかったのを修正（skill.c）
　味方であっても不死や悪魔であればダメージが入るように修正
	from AthenaProject Forum, thanks

・セージスキルのテイミングモンスターの処理を少し最適化（skill.c）
・skill_am_twilight1(), skill_am_twilight2(), skill_am_twilight3() をまとめて
　skill_am_twilight() とする（skill.c）

----------------------------------------
//0285 [2007/08/22] by Rayce

・pointshopを2007-07-11aSakexe以降のクライアントに対応（clif.c）
	0x289のパケット長を見て処理分岐しています。
	0x288に付属してる末端の4byte分は謎なので無視。

・doc/client_packet.txt更新
・SQL: `hotkey` テーブルにKEYを張り忘れてたので追加（Auriga285_changetable.sql）

----------------------------------------
//0284 [2007/08/22] by Rayce

・スペシャルアイテム販売NPCの実装（clif.*, map.h, npc.*, pc.c）
	pointshopでNPCを定義します。
	shopと同じ形式ですが、<point>に負数を指定するとそのまま負数になるので注意。
	課金アイテムに限らずあらゆるアイテムをポイントで販売することができます。
	プレイヤーのショップポイントはキャラ永続変数 PC_SHOP_POINT に保存されます。
	埋め込み変数として実装されているので、db/const.txtにある通り変数の操作が可能です。
	例えばスクリプトから以下のような形でポイントを与えます。
		set PC_SHOP_POINT,100;

　※2007-07-11aSakexe以降のクライアントには対応していません。
　　修正されるまでpointshopは使わないで下さい。

・db/packet_db.txtに "npcpointshopbuy" を追加
・doc/script_ref.txt更新

----------------------------------------
//0283 [2007/08/21] by Rayce

・0x272eのパケット処理部分を少し修正（char.c）
・skill_check_condition2_pc() でSP消費なしの場合、すぐにreturnで返すと以降の処理が無視されてしまう
　ので、変数spを0にするだけに修正（skill.c）
・カートレボリューションの範囲攻撃の挙動が狂っていたバグを修正（skill.c）
	reported by Cocoaさん

・スクリプトの menu/select命令 の拡張 from eA（script.c）
	メニューに ":" (半角コロン) を含む文字列を渡した場合も正常に値が返るようになります。
	":" は蔵の仕様上デリミタとして扱われるので、メニュー選択後に補正します。

　　例１）select("AA:BB:CC") は select("AA","BB","CC") と同じ
　　　　　"AA" -> 1, "BB" -> 2, "CC" -> 3
　　例２）select("AA:BB::CC") は select("AA","BB","","CC") と同じ
　　　　　"AA" -> 1, "BB" -> 2, "CC" -> 4
　　例３）select("AA:","BB:CC") は select("AA","","BB","CC") と同じ
　　　　　"AA" -> 1, "BB" -> 3, "CC" -> 4

----------------------------------------
//0282 [2007/08/21] by Rayce

・サーバ側でのホットキー保存に対応（mmo.h, char.c, clif.*, pc.c）
	merged from AthenaProject, thanks a lot!!

　※TXTに関してですが、eAのようにsave/hotkeys.txtとして別ファイルに保存することも考えましたが
　　journalとかの兼ね合いで面倒になったのでAthenaProjectに沿ってsave/auriga.txtに保存しています。
　　ただし保存形式は異なるので注意。
　　本パッチ以降、Athenaからのセーブデータの流用が完全に不可能になります！
　　SQLに関してもAthenaと比較してフィールドが一つ増えてるので注意。

・db/packet_db.txtを2007-05-07と2007-07-11までサポート
・TXT: JOURNAL_IDENTIFIERをバージョン05に変更しておく（journal.c）
・SQL: main.sql修正、Auriga-0282_changetable.sql添付
・SQL: txt-converterをホットキーに対応（char-converter.c）

・@hotkeyset追加（atcommand.*, clif.c, map.h）
	ホットキーを27個以上登録/利用できるようにするための拡張システム。
	mmo.hのMAX_HOTKEYSをデフォルトの27よりも大きく設定している場合に意味があります。
	9x3ページ = 27個を1セットとして扱い、ホットキーセットを切り替えることで擬似的に
	ページを増やします。
	@hotkeysetを使ったあとF12でページをめくったりすると画面に更新されます。

　　例）MAX_HOTKEYSを54にしている場合
　　　　　　@hotkeyset 0 →  0 〜 26まで
　　　　　　@hotkeyset 1 → 27 〜 53まで

----------------------------------------
//0281 [2007/08/19] by Rayce

・ipに関する型をunsigned long型に統一
・portに関する型をunsigned short型に統一

・ファイルへの書き込みを fopen() ではなく lock_fopen() を使うように修正（core.c, db.c）
・lock_fopen() で10000回トライしても安全なファイル名が得られない場合はNULLを返すように修正（lock.c）
・gccでの警告潰し（skill.c）

----------------------------------------
//0280 [2007/08/19] by Rayce

・MAPサーバ分散している状態でギルド倉庫を利用すると、MAPサーバ間でアイテムデータの同期が取れないため
　預けたはずのアイテムが見えなくなったり容易にデュープが発生する致命的な問題を修正
　（mmo.h, int_storage.*, intif.c, script.c）
	-> guild_storage構造体にメンバ last_fd を追加
	-> ギルド倉庫のロック取得権をinter鯖に依頼したとき、最後にギルド倉庫を利用したMAP鯖と同じか
	   どうかを照合して、異なる場合はリロードフラグを返す
	-> MAP鯖が intif_parse_TrylockGuildStorageAck() でリロードフラグを受け取ったときは
	   ギルド倉庫のキャッシュを削除してinter鯖から倉庫データを再取得させるようにする
	-> MAP鯖分散してない場合はこれまでの処理とほぼ変化はない
	-> gstorage_save() に引数を1つ追加、SQL専用
	   easyの場合は storage_status や last_fd を書き換えるだけにして、アイテムデータのクエリを発行
	   しなくて済むように改善

----------------------------------------
//0279 [2007/08/18] by Rayce

・暖かい風に関する修正（pc.c, skill.c, status.c）
	-> SC_SEVENWIND追加
	-> 聖はアスペルシオと同じだが、他はSC_SEVENWIND状態となる
	-> SC_SEVENWINDは属性付与（フレイムランチャー等）とは重複しない
	   ただし既にエンチャントポイズンが掛かっている場合は、そのエンチャントポイズンは解除しない
	   毒属性は無くなるが毒付与の機能だけ残る
	-> 聖以外は武器を持ち替えても効果が消えない

　※実質的にAthena1380まで巻き戻した形となります。
　　従ってAthena1399で追加された SC_DARKELEMENT, SC_ATTENELEMENT は使われなくなりました。
　　今後はスクリプトのsc_start命令などからのみ発現可能です。

・db/scdata_db.txtの変更
	-> SC_DARKELEMENT がゴスペル使用時に解除されるようにしてみる
	-> SC_ATTENELEMENT, SC_UNDEADELEMENT がゴスペル使用時とディスペルで解除されるようにしてみる
	-> SC_SEVENWIND は死亡時に解除されない以外は他の属性付与と同じ性質にしてみる

・関数名のtypo修正（pc.c, status.*）
	status_encchant_eremental_end      → status_enchant_elemental_end
	status_enchant_armor_eremental_end → status_enchant_armor_elemental_end

----------------------------------------
//0278 [2007/08/18] by Rayce

・battle_configに関して（battle.*, pc.c）
	-> battle_configの初期化にデフォルト値の設定をまとめる based on eA
	-> デフォルト値がconf/battle_auriga.confの値と合っていない箇所を修正
	-> battle_auriga.confのItem_resをitem_resに改名

・chat_data構造体のメンバの型を最適化（map.h）
・chat.cの細かい整形（chat.c）

----------------------------------------
//0277 [2007/08/18] by Rayce

・charサーバがmapサーバから担当マップ名を受信する際（0x2afa）、1024MAP以上でバッファオーバーフローが
　発生するときはcharサーバではなくmapサーバを落とすように変更（char.c）
・0x2afcでの認証に失敗したときの警告文を少し変更（char.c）
・auth_fifoのメンバ tick をunsigned int型に修正（login.c, char.c）
・login.cおよびchar.cの細かい整形（login.c, char.c）

・skill_additional_effect() の整形（skill.c）
・battle_damage() および battle_delay_damage() に引数を2つ追加（battle.*, skill.c, unit.c）
　スキルIDとスキルLvを参照できるようになります
・以下のスキルはディボーションでダメージを肩代わりできないように修正（battle.c）
	プレッシャー
	コーマ
	NPCダークブレッシング
	グランドクロスの反動

----------------------------------------
//0276 [2007/08/17] by Rayce

・0019以降、Mobに先制攻撃されると経験値が全く入らなくなってしまうバグを修正（mob.c）
・0225以降、キャラを新規作成するとキャラ名の末尾にゴミ文字が付加するバグを多分修正（char.c）
	reported by Cocoaさん and ぽぽりさん

----------------------------------------
//0275 [2007/08/17] by Rayce

・ディボーションの修正（battle.c, skill.c, status.c, unit.c）
	-> 献身対象者から来るダメージによって術者の詠唱が妨害されるように修正
	-> 献身対象者がダメージを受けても献身対象者の凍結/石化/睡眠が解除されないように修正
	-> 献身対象者がダメージを食らった場合、術者に被弾共闘が入るように修正
	-> 献身対象者がダメージを食らったとき術者が位置ズレを起こすので、ダメージディレイ
	   （ヒットストップ）を入れるように修正してみる
	-> 術者がインデュア、オートガード、リフレクトシールド、ディフェンダーを使ったら
	   献身対象者にも同じ効果がかかるように修正
	   ただし被ディボーション者にかかるディフェンダーは強制的にLv1
	-> 術者がインデュア、オートガード、リフレクトシールド、ディフェンダーを解除したら
	   献身対象者も解除されるように修正
	-> ディボーションが終了したとき、献身対象者にかかっているインデュア、オートガード、
	   リフレクトシールド、ディフェンダーを全て解除するように修正
	-> 献身対象者にかかったリフレクトシールドはプレイヤーから攻撃されたときのみ効果が
	   発動するように修正
	-> 定員がいっぱいのときは詠唱できずにスキル使用失敗となるように修正
	-> 違うクルセから既にディボーションされている人にはスキルが使用できないように修正
	-> Mobに対してスキルを使用したとき詠唱反応Mobのタゲ取りができるように修正
	-> ディボーション解除時の処理方法を少し変更
	   skill_devotion_end() は skill_devotion() に取り込んだので削除
	-> skill_devotion3() で既に糸が切れているときはパケット送信しないように改善
	-> stauts_change_start() で不要なステータス再計算をしないように修正

　※インデュア、オートガード、リフレクトシールド、ディフェンダーに関連する部分は本鯖の挙動が
　　イマイチわからないのでeAのコードを参考にしています。

・オートガードのガード確率計算式を一般式化（status.c）
・紛らわしい変数名を変更（clif.c, skill.*）

----------------------------------------
//0274 [2007/08/16] by Rayce

・ステータス異常 SC_ITEM_DELAY と SC_ACTION_DELAY の撤廃（clif.c, map.h, pc.c, status.*）
	プレイヤーにしか必要がない上に、不正検出のための重要なシステムでありながらスクリプトの
	sc_start命令等で操作される可能性があるという極めて良くない実装でした。
	代わりにmap_session_data構造体にメンバ item_delay_tick, drop_delay_tick, drop_delay_count
	を用意してこれまでと同様の不正検出を行うことにします。

・map_session_data構造体のメンバemotion_lasttickをemotion_delay_tickに改名（clif.c, map.h, pc.c）
・map_session_data構造体のメンバinfinit_tigereyeをspecial_stateに変更（map.h, pc.c, status.c）

・dropitem命令を使ったスクリプトの引数指定方法が間違っていたので修正（npc_quest_kiel.txt）
	reported by Cocoaさん

----------------------------------------
//0273 [2007/08/15] by Rayce

・倉庫関連の関数を見直し（mmo.h, guild.c, intif.c, storage.*, unit.c）
	-> intif_parse_LoadStorage() の内容を storage_storageload() として分離
	-> intif_parse_LoadGuildStorage() の内容を storage_guild_storageload() として分離
	-> storage_storage_quit() および storage_guild_storage_quit() はそれぞれ
	   storage_storageclose() および storage_guild_storageclose() にまとめる
	-> ギルド解散時にギルドメンバーが倉庫を開いていた場合の処理を少し書き換え
	-> storage構造体およびguild_storage構造体にdirtyメンバを追加
	   倉庫内アイテムのデータが変更されたときのみセーブを行うように改善
	-> 細かい整形

・pc_takeitem_sub() でPT未所属でもPT共有設定とみなされていた問題を修正（pc.c）
・account_db_final() におけるキャストミスを修正（login.c）
	thanks to FPE in AthenaProject Forum

----------------------------------------
//0272 [2007/08/14] by Rayce

・死んだ状態から@loadや@goなどで pc_setpos() を実行すると、デスペナが無くなったり
　移動先ですぐに死んでしまう等の問題を修正（clif.c, pc.c）
・VC++で警告レベルを /W4 にした際に得られた結果の中で気になった箇所を修正
　（db.c, malloc.c, socket.c, char.c, int_guild.c, clif.c, map.h, pc.c, status.c, login-converter.c）

・converterの起動時にもコマンドライン引数をサポートする（converter.*）
　　以下のコマンドを使ってconfファイルへのパスを変更することができます。

　　converter
	--converter-config <filename>

----------------------------------------
//0271 [2007/08/13] by Rayce

・AthenaProject2314よりmerge、thanks to Paraさん
	-> clif_sitting() を少し変更して「立つ」処理もまとめる（clif.*, skill.c）
	-> スクリプトにgetcartlist命令を追加（script.c）

・カート内アイテム削除命令を一式追加（script.c）
　これらはプレイヤーがカートを持っていなくてもアイテムの削除を行います
　カートがあるときだけ削除したい場合はcheckcart関数でカートの有無をチェックする必要があります
	delcartitem命令
	delcartitem2命令
	clearcartitem命令

・delinventory命令をdelitem2命令に改名（script.c）
	カート用の命令と一律の名前にするため
	delinventory命令をスクリプトで利用している場合は各自delitem2命令に変更してください

----------------------------------------
//0270 [2007/08/13] by Rayce

・db/item_avail.txtを使ったアイテムをshop販売するとアイテム数超過扱いにされて
　アイテムが買えない問題を修正（npc.c）
	ただし販売品目の中でavail元のアイテムIDが重複している場合にアイテムを正しく
	買うことができませんが、これはクライアントの仕様に依ります。
	例えばdb/item_avail.txtに 600,512 を記述して600のIDを作ったとき
		prontera.gat,116,192,4	shop	shopper	112,512:10,600:10
	となっている場合は600のアイテムを買うことができません（恐らく512になる）
	この事例が発生し得るときはdb/item_avail.txtを使わないことをお勧めします。

・ELE_MAXを10より小さい値に設定している場合、モンスター情報を使うと「unknown attr type」
　のエラー文が出るバグを修正（clif.c）
・鉱石の製造確率でDEX依存部分の計算式が間違っていたのを修正（skill.c）
	reported by Cocoaさん

----------------------------------------
//0269 [2007/08/12] by Rayce

・スキル使用チェック時のアイテム消費処理を skill_item_consume() としてまとめる（skill.c）
	-> inf2で処理分岐せず、植物栽培も一つにまとめる
	-> アイテム消費なしにする場合はgotoを使わずitem_nocostフラグをオンにする
	-> 副作用としてホムがジェムの必要なスキルを使うとき、主人がミストレスカードを
	   装備していればジェム消費なしになる

----------------------------------------
//0268 [2007/08/10] by Rayce

・nextやselectで待機中に run_script() が再帰的に実行されると元のスクリプトが
　破棄されてスクリプトがそれ以降停止してしまうバグを修正（script.c）
・別MAPに移動すると地面に設置したスキルユニットが消滅するように修正（pc.c）
	reported by Cocoaさん

----------------------------------------
//0267 [2007/08/09] by Rayce

・クレイモアトラップが攻撃されても移動しないように修正（battle.c, skill.c）
・PTメンバーのHPが0x7fffを越えている場合、HPメーターが更新されない問題を修正（clif.c）
　MAXHPが0x7fffのときは0x7fffで規格化する
・party_send_xyhp_timer() を少し修正（party.c）
・gccでの警告修正（pc.c）

・以下のファイルの改行コードをCR/LFに変更
	script/npc/town/npc_town_hugel.txt
	src/common/zlib/
	src/map/status.c

----------------------------------------
//0266 [2007/08/01] by Rayce

・オートスペルでリムーブトラップが使えないバグを修正（battle.c, skill.c, unit.c）
	db/skill_db.txtのinfが32の罠の場合は、場所スキルとしてではなく対象指定スキルとして
	扱われなければなりません

・運命のタロットカード専用の状態異常 SC_THE_MAGICIAN, SC_STRENGTH, SC_THE_DEVIL, SC_THE_SUN の
　使い方が特殊だったので仕様変更（skill.c, status.*）
	-> 魔法師、力、悪魔、太陽の効果がそれぞれ重複するようにしてみる
	-> 不要になった SC_TAROTCARD を削除

・ディテクティング用の状態異常 SC_DETECTING の使い方が特殊だったので仕様変更（skill.c, status.*）
	-> サイトと同じ処理方法で周囲のPCおよびMOBを炙り出す
	-> ディテクティングでNPCインビジブルが見破れなくなるが当面の間仕様にしておく
	-> 不要になった SC_DETECTING を削除

----------------------------------------
//0265 [2007/08/01] by Rayce

・スキルのstatictimerをギルドスキルも一括して扱えるように変更（map.h）
・臨戦態勢、激励、治療、緊急召集のスキルディレイはstatictimerを使うように変更（clif.c, skill,c status.*）
　以下のステータス異常は不要になったので削除
	SC_BATTLEORDER_DELAY
	SC_REGENERATION_DELAY,
	SC_RESTORE_DELAY
	SC_EMERGENCYCALL_DELAY,
・スキルのstatictimerの初期化が二重に行われていた無駄を修正（pc.c）
	pc_setnewpc() ではなく pc_authok() だけで行えば良い

----------------------------------------
//0264 [2007/08/01] by Rayce

・オートスペル使用後にディレイが無かったのを修正（battle.*, skill.*）
	battle_auriga.confに skill_autospell_delay_enable と bonus_autospell_delay_enable を追加
	スキル由来かアイテムボーナス由来かで個別に設定できます
	デフォルトでは共にyesですが、noにすれば今まで通りディレイ無しになります

・skill_bonus_autospell() の引数tickがunsigned int型になっていなかったので修正（skill.*）

----------------------------------------
//0263 [2007/07/30] by Rayce

・サーバースナップショット（version.h）
・不要なファイルをフォルダごと削除
	./script/mosnter/etc
